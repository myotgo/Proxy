# لایه ۷: بهینه‌شده ایران (gRPC) - تنظیم‌شده برای ISP‌های ایران

> **⭐⭐⭐⭐⭐ بهترین برای ایران (بهینه برای دور زدن DPI/throttling)**
> پورت 443 - VLESS + gRPC + TLS واقعی + بهینه‌سازی‌های مخصوص ایران

[← بازگشت به راهنمای اصلی](../README.fa.md)

---

## این روش چیست؟

این روش بر پایه **لایه ۷: دامنه واقعی** است اما با بهینه‌سازی‌های اضافی که مخصوصاً برای دور زدن DPI (بازرسی عمیق بسته) و throttling اینترنت ایران طراحی شده‌اند.

**تنظیمات مخصوص ایران:**
- پینگ keepalive برای gRPC (جلوگیری از قطع اتصالات بیکار توسط ISP)
- TLS 1.2-1.3 + h2 ALPN (اثر انگشت مشابه Chrome/Android)
- بافرهای کوچک (16KB، مقاوم در برابر از دست رفتن بسته)
- تایم‌اوت کوتاه (جلوگیری از تحلیل جریان)
- API آمار فعال برای مانیتورینگ

**چرا این روش بهتر از دامنه واقعی است:**
- پایداری بهتر در شبکه‌های ایرانی
- مقاوم در برابر ریست اتصال توسط ISP
- بهینه برای محیط‌های با از دست رفتن بالای بسته
- اقدامات ضد DPI داخلی

**امنیت:** ⭐⭐⭐⭐⭐
**مخفی‌سازی:** ⭐⭐⭐⭐⭐
**پایداری ایران:** ⭐⭐⭐⭐⭐

---

## نیازمندی اصلی: دامنه

برای این روش به یک دامنه نیاز دارید.

**گزینه ۱: DuckDNS (رایگان و پیشنهادی)**
- کاملاً رایگان
- آسان برای راه‌اندازی
- زیردامنه دریافت می‌کنید (مثلاً myproxy.duckdns.org)

**گزینه ۲: دامنه پولی**
- از هر سایت ثبت دامنه بخرید
- کنترل کامل دارید
- حرفه‌ای‌تر است

---

--------------------------------------------------
مرحله ۱: خرید سرور VPS
--------------------------------------------------

**اگر از قبل سرور لینوکس با Ubuntu دارید، این مرحله را رد کنید و به مرحله ۲ بروید.**

**برای خرید از IONOS (پیشنهادی):** [راهنمای خرید سرور از IONOS](../buy-ionos-server.fa.md)

### نکات خرید:
- سیستم‌عامل: **Ubuntu**
- پلن ارزان کافی است
- لوکیشن به انتخاب شما

**اطلاعات مورد نیاز از سرور:**
- IP سرور (این را یادداشت کنید!)
- نام کاربری: root
- رمز عبور

---

--------------------------------------------------
مرحله ۲: دریافت دامنه رایگان (DuckDNS)
--------------------------------------------------

**برای راهنمای کامل با تصویر:** [راهنمای دریافت دامنه رایگان از DuckDNS](../get-free-domain.fa.md)

### خلاصه مراحل:

### قدم ۱: ثبت‌نام در DuckDNS

وارد شوید: https://duckdns.org

با GitHub یا Google لاگین کنید.

### قدم ۲: ساخت زیردامنه

یک نام انتخاب کنید (مثلاً):
```
myproxy123.duckdns.org
```

IP سرور خود را در کادر IP وارد کنید.

TOKEN خود را کپی کنید (نگه دارید).

---

--------------------------------------------------
مرحله ۳: اتصال SSH
--------------------------------------------------

**[راهنمای اتصال به سرور با SSH](../ssh-connection.fa.md)**

خلاصه:
```bash
ssh root@SERVER-IP
```

---

--------------------------------------------------
مرحله ۴: نصب لایه ۷ (بهینه‌شده ایران)
--------------------------------------------------

این دستور را اجرا کنید:

```bash
curl -fsSL https://raw.githubusercontent.com/myotgo/Proxy/main/layer7-iran-optimized/install.sh -o install.sh && bash install.sh
```

**در طول نصب از شما پرسیده می‌شود:**
1. دامنه شما (مثلاً: myproxy123.duckdns.org)
2. ایمیل شما (برای Let's Encrypt)
3. توکن DuckDNS (اگر از دامنه .duckdns.org استفاده می‌کنید)

اسکریپت:
- گواهی TLS معتبر می‌گیرد
- VLESS gRPC را روی پورت 443 راه‌اندازی می‌کند
- اقدامات ضد DPI مخصوص ایران را اعمال می‌کند
- تنظیمات keepalive برای gRPC را فعال می‌کند
- API آمار را برای مانیتورینگ فعال می‌کند

---

--------------------------------------------------
مرحله ۵: اضافه کردن کاربر
--------------------------------------------------

برای هر نفر یک کاربر بسازید. بعد از اضافه کردن کاربر، **۲ کانفیگ JSON** نمایش داده می‌شود:
- کانفیگ iOS (برای NPV Tunnel)
- کانفیگ Android (برای NetMod)

```bash
curl -fsSL https://raw.githubusercontent.com/myotgo/Proxy/main/layer7-iran-optimized/add-user.sh -o add-user.sh && bash add-user.sh
```

**توجه:** اگر همان نام کاربری را دوباره اضافه کنید، همان کانفیگ قبلی برگردانده می‌شود.

---

--------------------------------------------------
مرحله ۶: مانیتورینگ کاربران
--------------------------------------------------

برای مشاهده کاربران متصل و وضعیت سرور:

```bash
curl -fsSL https://raw.githubusercontent.com/myotgo/Proxy/main/common/view-users.sh -o view-users.sh && bash view-users.sh
```

---

--------------------------------------------------
مرحله ۷: حذف کاربر (در صورت نیاز)
--------------------------------------------------

```bash
curl -fsSL https://raw.githubusercontent.com/myotgo/Proxy/main/layer7-iran-optimized/delete-user.sh -o delete-user.sh && bash delete-user.sh username
```

بعد از حذف، کاربر دیگر نمی‌تواند با کانفیگ قبلی متصل شود.

---

## استفاده در iOS

[راهنمای اتصال با iOS (NPV Tunnel)](../layer7-real-domain/iOS-SETUP.fa.md)

---

## استفاده در Android

[راهنمای اتصال با Android (NetMod)](../layer7-real-domain/ANDROID-SETUP.fa.md)

---

## آپدیت خودکار DNS (اختیاری)

اگر IP سرور عوض شود، این دستور را روی سرور اجرا کنید:

```bash
curl "https://www.duckdns.org/update?domains=myproxy123&token=YOUR_TOKEN&ip="
```

برای آپدیت خودکار هر 5 دقیقه:

```bash
crontab -e
```

این خط را اضافه کنید:
```
*/5 * * * * curl -fs "https://www.duckdns.org/update?domains=myproxy123&token=YOUR_TOKEN&ip=" >/dev/null
```

---

## نکات مهم

- این **بهترین روش برای کاربران ایرانی** است
- از DPI، فیلتر SNI، و Active Probing عبور می‌کند
- گواهی معتبر مرورگر دارد
- keepalive برای gRPC از قطع شدن بیکار جلوگیری می‌کند
- اثر انگشت TLS مشابه مرورگرهای Chrome/Android
- برای iOS: NPV Tunnel
- برای Android: NetMod / V2RayNG
- دامنه و UUID را ایمن نگه دارید

---

## خلاصه نهایی

| سوال | پاسخ |
|------|------|
| کاملاً رایگان؟ | بله (با DuckDNS) |
| سخت برای فیلتر شدن؟ | بسیار سخت |
| مناسب ایران؟ | بهترین گزینه |
| نیاز به دامنه؟ | بله (DuckDNS رایگان) |
| مقاوم در برابر DPI? | بله |

---
